---
layout:     post
title:      "mysql的锁"
subtitle:   "mysql"
date:       2019-01-18 12:00:00
author:     "lyxiang"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - mysql
---

<p id = "build"></p>

# mysql的锁

## 存储引擎和锁

| | 表锁 | 行锁 | 页锁 |
|:--------:|:--------:|:--------:|:--------:|
| MyISAM | 支持 | 不支持 | 不支持 |
| BDB | 支持 | 支持 | 不支持 |
| InnoDB | 支持 | 支持 | 不支持 |

## 锁模式
### 表锁
* 概念：整个表读写数据失败
* 特点：开销小，加锁快。不会出现死锁。锁的颗粒度大，并发低。
* 查看锁表的命令：show open tables where In_use > 0;
* 场景：DDL操作会出发表锁(创建、删除、修改、库或表结构，对数据库或表的结构操作)

### 行锁
* 概念：给单独的一条记录加锁。
* 特点：支持事务，开销大，加锁慢。会出现死锁。锁的粒度小，并发情况下，产生锁等待的几率较小，可支持较高的并发数。
* 查看行锁的命令：show status like 'innodb_row_lock%';
* 场景：事务提交前，该行数据被其他sql更新。

## 锁类型
### 共享锁(S锁)
* 概念：共享锁：shared lock， 也成为读锁（read lock）
* 功能：若事务T对数据对象A加上S锁，则事务T可以读但是不能修改A。其他事务，可以对A加S锁，但是不能加X锁。直到事务T释放A上的S锁。这保证了其他事务可以读A，但是在T提交之前，其他事务不能修改A。
* 示例：

```
//对数据对象A加上S锁
start transaction;
select * from yitiao_user_coupon where id = 90 LOCK IN SHARE MODE;  //commit之后，就会释放S锁

//在看一个事务，去更新数据对象A
start transaction;
update yitiao_user_coupon set coupon_id = 9 where id = 90;  //等待锁

//查看锁sql
select * from information_schema.processlist where COMMAND = 'Query' and db = 'xxx';

//杀死锁
kill id

```

### 排他锁(X锁)
* 概念：排他锁：exclusive lock，也叫写锁（wirte lock）
* 功能：若事务T对数据对象A加上X锁，则事务T可以读和修改A。其他事务，不可以对A加任何锁。直到事务T提交，释放A上的X锁。这保证了其他事务在T释放A上的锁之前不能再读取和修改A。
* 示例：

```
//对数据对象A加上S锁
start transaction;
select * from yitiao_user_coupon where id = 90 for update;  //commit之后，就会释放S锁

//在看一个事务，去更新数据对象A
start transaction;
select * from yitiao_user_coupon where id = 90 LOCK IN SHARE MODE;  //等待锁

//查看锁sql
select * from information_schema.processlist where COMMAND = 'Query' and db = 'xxx';

//杀死锁
kill id

```
