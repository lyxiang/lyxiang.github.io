---
layout: post
title: Mysql的乐观锁和悲观锁
categories: Mysql, Java
keywords: 乐观锁，悲观锁，Mysql
---

在数据库当中，数据也是一种供许多用户共享访问的资源。如何保证数据并发访问的一致性、有效性，是所有数据库必须解决的一个问题，锁的冲突也是影响数据库并发访问性能的一个重要因素。从这一角度来说，锁对于数据库而言就显得尤为重要

---

## 场景描述
* 在做电商业务，我们会经常碰到这么一种情况。某个sku库存仅剩1，有10个用户在同时浏览，用户看到的库存都是1。然后这10个用户同时下单，如果下单业务系统这个地方没有并发处理，就会发生超卖情况。当然，实际的业务系统中，肯定是会做并发处理的。常见的处理方式也就是对库存加锁。
* 常见的加锁方式如下文所示：

## 悲观锁
* 悲观锁，是指对数据被外界修改持有保守态度。在数据处理的过程中，将数据锁起来。依靠数据库提供的锁机制来实现。
* 使用悲观锁的时候，要关闭mysql的自动提交属性。set autocommit=0;
* 行锁：指定列有索引, 锁当前的行
* 表锁：指定列没有索引, 锁整个表
* select for update,才会收到影响。select操作不会受到影响。

```
//开始事务
begin;begin work;start transaction; (三者均可)

//查询出商品信息
select status from t_goods where id=1 for update;

//根据商品信息生成订单
insert into t_orders (id,goods_id) values (null,1);

//修改商品status为2
update t_goods set status=2;

//提交事务
commit;commit work;(两者均可)

```

## 乐观锁
* 乐观锁一般认为数据不会冲突，在更新的时候，才会去检查数据是否被修改过。如果修改过，则返回错误信息，让用户去决定怎么做。

### 实现机制
* 数据版本记录实现：这是乐观锁最常用的一种实现方式。何谓数据版本？即为数据增加一个版本标识，一般是通过为数据库表增加一个数字类型的 “version” 字段来实现。当读取数据时，将version字段的值一同读出，数据每更新一次，对此version值加一。当我们提交更新的时候，判断数据库表对应记录的当前版本信息与第一次取出来的version值进行比对，如果数据库表当前版本号与第一次取出来的version值相等，则予以更新，否则认为是过期数据。

* 乐观锁定的第二种实现方式和第一种差不多，同样是在需要乐观锁控制的table中增加一个字段，名称无所谓，字段类型使用时间戳（timestamp）, 和上面的version类似，也是在更新提交的时候检查当前数据库中数据的时间戳和自己更新前取到的时间戳进行对比，如果一致则OK，否则就是版本冲突。
